# MQ Message Spec Excel 自动化生成工具需求分析文档

**文档版本**: v1.2
**创建日期**: 2026-01-03
**最后更新**: 2026-01-03
**文档状态**: 待评审

---

## 目录

1. [项目背景与目标](#1-项目背景与目标)
2. [明确排除范围 (Non-Goals / Out of Scope)](#2-明确排除范围-non-goals--out-of-scope)
3. [功能需求](#3-功能需求)
4. [非功能需求](#4-非功能需求)
5. [配置参数与命令行接口](#5-配置参数与命令行接口)
6. [数据模型与映射规则](#6-数据模型与映射规则)
7. [验证规则](#7-验证规则)
8. [审计要求](#8-审计要求)
9. [验收标准](#9-验收标准)
10. [测试策略](#10-测试策略)
11. [假设与待确认项](#11-假设与待确认项)
12. [输出制品清单](#12-输出制品清单)
13. [依赖与风险](#13-依赖与风险)

---

## 1. 项目背景与目标

### 1.1 业务背景

公司内部系统按照业务领域与请求链路进行分层解耦，请求链路为：

```
EAPI -> PAPI -> SAPI -> APE
```

其中：
- SAPI 与 APE 之间通过 **IBM MQ** 通信
- 报文格式为 **Fixed-Length（定长报文）**
- 报文规范由 **Message Spec Excel** 文件定义

### 1.2 当前痛点

| 痛点编号 | 问题描述 | 影响 |
|---------|---------|------|
| P-001 | 人工编写 request/response XML bean 文件，字段顺序、层级、名称必须与 Excel 完全一致 | 易出错，效率低 |
| P-002 | 人工编写对应的 Java Bean 类，字段名称、数据类型必须与 XML 定义一致 | 一致性难以保证 |
| P-003 | Excel 通常包含 400~500 行甚至更多字段 | 人工处理工作量巨大 |
| P-004 | 错误往往在运行期或联调期才暴露 | 问题发现成本极高 |
| P-005 | 缺乏统一的审计、溯源和一致性校验能力 | 无法追溯问题根因 |
| P-006 | 需要额外编写 OpenAPI YAML 定义，且需与 Java Bean 保持一致 | 重复工作，易不一致 |

### 1.3 项目目标

开发一个自动化工具，实现基于 MQ Message Spec Excel 的自动化生成与校验能力：

1. **自动解析** Excel 规范文件，提取字段定义
2. **自动生成** XML Bean、Java Bean、OpenAPI YAML 制品
3. **确保一致性** 跨制品字段定义完全一致
4. **支持审计** 完整的溯源与复现能力
5. **支持验证** 规格与实际报文的一致性校验

---

## 2. 明确排除范围 (Non-Goals / Out of Scope)

以下内容明确**不在**本项目范围内：

| 排除项编号 | 排除内容 | 说明 |
|-----------|---------|------|
| EX-001 | MQ 运行时基础设施建设 | 不涉及 IBM MQ 服务器部署、队列配置等 |
| EX-002 | 企业安全组件重新设计 | 不修改现有安全认证、授权机制 |
| EX-003 | FlowService 组件修改 | 不修改公司封装的 MQ 发送/接收组件 |
| EX-004 | Kotlin 业务逻辑生成 | 不自动生成 PostFlow、Mapper 等 Kotlin 代码 |
| EX-005 | Controller 代码生成 | Controller 由 Maven OpenAPI 插件生成，本工具不涉及 |
| EX-006 | Excel 规范文件格式重新设计 | 接受现有 Excel 格式作为输入 |
| EX-007 | 历史数据迁移 | 不处理已有项目的迁移工作 |
| EX-008 | 可视化界面开发 | 本期仅提供命令行工具,不支持 GUI 或 Web 界面 |
| EX-009 | 多语言支持 | 仅支持生成 Java Bean（不支持其他语言） |
| EX-010 | 实时报文监控 | 不提供生产环境报文实时监控能力 |
| EX-011 | 批量处理多个 Excel 文件 | 本期仅支持单个 Message Spec Excel 处理，批量需求可通过脚本循环调用 |

---

## 3. 功能需求

### 3.1 Excel 解析与中间 JSON 树生成 (FR-001)

#### 3.1.1 功能描述

解析 MQ Message Spec Excel 文件，生成中间 JSON 树结构文件，作为后续所有生成器的统一输入。

#### 3.1.2 用户故事

**US-001**: 作为开发人员，我希望将 Excel 规范文件转换为结构化的 JSON 树，以便后续生成器可以基于统一的数据源进行处理。

#### 3.1.3 详细需求

| 需求编号 | 需求描述 | 优先级 |
|---------|---------|--------|
| FR-001-01 | 支持解析包含 shared header / request / response 多个 sheet 的 Excel 文件 | P0 |
| FR-001-02 | 根据 Seg lvl 列正确识别对象层级关系并构建嵌套结构 | P0 |
| FR-001-03 | 根据 occurrenceCount 判断对象类型：0..N / 1..N 为数组，1..1 为复合对象 | P0 |
| FR-001-04 | 严格保持 Excel 中定义的字段顺序 | P0 |
| FR-001-05 | 保留源元数据：sheet 名称、行号、原始字段名、长度、datatype、默认值、occurrenceCount | P0 |
| FR-001-06 | 支持加载并合并独立的 Shared Header Excel 文件 | P0 |
| FR-001-07 | 识别对象定义：Field Name 形如 `a:A` 且 Length、Message Datatype 为空 | P0 |
| FR-001-08 | 将 JSON 树输出为独立文件（路径：`parser/schema/spec-tree.json`） | P0 |

#### 3.1.4 中间 JSON 树 Schema 定义

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "MQ Spec Intermediate JSON Tree",
  "type": "object",
  "properties": {
    "metadata": {
      "type": "object",
      "properties": {
        "sourceFile": { "type": "string" },
        "sharedHeaderFile": { "type": "string" },
        "parseTimestamp": { "type": "string", "format": "date-time" },
        "parserVersion": { "type": "string" },
        "operationName": { "type": "string" },
        "operationId": { "type": "string" }
      },
      "required": ["sourceFile", "parseTimestamp", "parserVersion"]
    },
    "sharedHeader": { "$ref": "#/definitions/fieldGroup" },
    "request": { "$ref": "#/definitions/fieldGroup" },
    "response": { "$ref": "#/definitions/fieldGroup" }
  },
  "definitions": {
    "fieldGroup": {
      "type": "object",
      "properties": {
        "fields": {
          "type": "array",
          "items": { "$ref": "#/definitions/fieldNode" }
        }
      }
    },
    "fieldNode": {
      "type": "object",
      "properties": {
        "originalName": { "type": "string" },
        "camelCaseName": { "type": "string" },
        "segLevel": { "type": "integer" },
        "length": { "type": ["integer", "null"] },
        "dataType": { "type": ["string", "null"] },
        "defaultValue": { "type": ["string", "null"] },
        "hardCodeValue": { "type": ["string", "null"] },
        "groupId": { "type": ["string", "null"] },
        "occurrenceCount": { "type": ["string", "null"] },
        "isArray": { "type": "boolean" },
        "isObject": { "type": "boolean" },
        "children": {
          "type": "array",
          "items": { "$ref": "#/definitions/fieldNode" }
        },
        "_source": {
          "type": "object",
          "properties": {
            "sheetName": { "type": "string" },
            "rowIndex": { "type": "integer" }
          }
        }
      },
      "required": ["originalName", "segLevel", "_source"]
    }
  }
}
```

#### 3.1.5 验收标准

- [ ] 解析结果层级结构与 Excel Seg lvl 定义完全一致
- [ ] 字段顺序与 Excel 行顺序完全一致
- [ ] 数组/对象类型判断正确（基于 occurrenceCount）
- [ ] 所有源元数据均被保留
- [ ] JSON 输出文件可被 JSON Schema 验证通过
- [ ] 相同输入产生相同输出（确定性）

---

### 3.2 XML Bean 生成 (FR-002)

#### 3.2.1 功能描述

根据中间 JSON 树生成符合公司组件规范的 request / response XML bean 文件。

#### 3.2.2 用户故事

**US-002**: 作为开发人员，我希望自动生成 XML bean 文件，以便公司内部组件能够正确序列化和反序列化 MQ 报文。

#### 3.2.3 详细需求

| 需求编号 | 需求描述 | 优先级 |
|---------|---------|--------|
| FR-002-01 | 生成 outbound-converter.xml（请求报文 XML bean） | P0 |
| FR-002-02 | 生成 inbound-converter.xml（响应报文 XML bean） | P0 |
| FR-002-03 | XML 字段顺序必须与 Excel 定义完全一致 | P0 |
| FR-002-04 | 正确设置 field 的 type 属性：DataField / CompositeField / RepeatingField | P0 |
| FR-002-05 | 正确设置 length、defaultValue、nullPad、converter 等属性 | P0 |
| FR-002-06 | groupId 必须包含在 XML bean 中（作为 transitory field） | P0 |
| FR-002-07 | occurrenceCount 必须体现在 XML bean 中（fixedCount 属性） | P0 |
| FR-002-08 | 支持模板可替换（XML 模板可配置） | P1 |
| FR-002-09 | forType 属性值遵循命名约定：`com.rtm.{project}.{ClassName}` | P0 |
| FR-002-10 | 包名前缀 `{project}` 通过参数化配置指定（如 `--project=creditcard`） | P0 |

**包命名规范**:
- **固定格式**: `com.rtm.{project}.{ClassName}`
- **示例**:
  - 项目名为 `creditcard`，类名为 `CreateApplicationRequest`
  - 完整类名: `com.rtm.creditcard.CreateApplicationRequest`
- **配置方式**: 通过命令行参数 `--project=<name>` 或配置文件指定项目名称

#### 3.2.4 XML Bean 结构规范（基于参考文件分析）

**请求 XML (outbound-converter.xml) 结构**:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans:beans xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xmlns="..." >
  <fix-length-outbound-converter id="req_converter" codeGen="true">
    <message forType="com.rtm.{project}.{OperationId}Request">
      <!-- groupId field (transitory) -->
      <field type="DataField" length="{length}" fixedLength="true"
             transitory="true" defaultValue="{groupId}"
             converter="stringFieldConverter" />
      <!-- occurrenceCount field (transitory) -->
      <field type="DataField" length="4" fixedLength="true"
             transitory="true" defaultValue="{count}" pad="0"
             alignRight="true" converter="counterFieldConverter" />
      <!-- CompositeField for object -->
      <field name="{fieldName}" type="CompositeField"
             forType="com.rtm.{project}.{ClassName}">
        <field name="{childName}" type="DataField"
               length="{length}" defaultValue="{default}"
               nullPad=" " converter="{converter}" />
      </field>
      <!-- RepeatingField for array -->
      <field name="{fieldName}" type="RepeatingField"
             fixedCount="{count}" forType="com.rtm.{project}.{ClassName}">
        <!-- child fields -->
      </field>
    </message>
  </fix-length-outbound-converter>
</beans:beans>
```

**响应 XML (inbound-converter.xml) 结构**:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans:beans xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xmlns="..." >
  <fix-length-inbound-converter id="resp_converter" codeGen="true">
    <message forType="com.rtm.{project}.{OperationId}Response">
      <!-- 结构与 outbound 类似 -->
    </message>
  </fix-length-inbound-converter>
</beans:beans>
```

#### 3.2.5 字段类型映射规则

| Excel dataType | XML field type | converter | 附加属性 |
|---------------|----------------|-----------|---------|
| String / AN | DataField | stringFieldConverter | nullPad=" " |
| Number / N | DataField | stringFieldConverter | pad="0", alignRight="true" |
| Amount / Currency | DataField | OHcurrencyamountFieldConverter | floatingNumberLength (总length - 3) |
| NLS String | DataField | nlsStringFieldConverter | nullPad=" " |
| Unsigned Long | DataField | OHunsignedlongFieldConverter | pad="0", alignRight="true" |
| Unsigned Int | DataField | OHunsignedintFieldConverter | pad="0", alignRight="true" |
| Counter | DataField | counterFieldConverter | pad="0", alignRight="true" |
| Object (1..1) | CompositeField | - | forType |
| Array (0..N, 1..N) | RepeatingField | - | fixedCount, forType |

**Converter 类型说明**:
- `stringFieldConverter`: 字符串类型转换器
- `counterFieldConverter`: 计数器类型转换器
- `OHcurrencyamountFieldConverter`: 金额类型转换器
- `nlsStringFieldConverter`: NLS 字符串类型转换器
- `OHunsignedlongFieldConverter`: 无符号长整型转换器
- `OHunsignedintFieldConverter`: 无符号整型转换器
- **支持通过配置映射扩展其他 converter 类型**

**floatingNumberLength 计算规则**:
- 对于金额类型(OHcurrencyamountFieldConverter),`floatingNumberLength = 总 length - 默认值字符串前缀长度`
- 默认值字符串前缀长度默认为 3
- 例如: 总长度为 15,则 floatingNumberLength = 15 - 3 = 12

#### 3.2.6 验收标准

- [ ] 生成的 XML 符合公司组件加载规范（可被正确解析）
- [ ] 字段顺序与 Excel 完全一致
- [ ] groupId 和 occurrenceCount 作为 transitory field 正确包含
- [ ] type、length、converter 等属性值正确
- [ ] forType 命名符合约定

---

### 3.3 Java Bean 生成 (FR-003)

#### 3.3.1 功能描述

根据中间 JSON 树生成 MQ 请求与响应的 Java Bean 类。

#### 3.3.2 用户故事

**US-003**: 作为开发人员，我希望自动生成 Java Bean 类，以便在业务代码中操作 MQ 请求和响应对象。

#### 3.3.3 详细需求

| 需求编号 | 需求描述 | 优先级 |
|---------|---------|--------|
| FR-003-01 | 请求类名必须包含 "Request" 后缀 | P0 |
| FR-003-02 | 响应类名必须包含 "Response" 后缀 | P0 |
| FR-003-03 | 字段名称必须转换为 camelCase | P0 |
| FR-003-04 | 数据类型必须与 XML Bean 定义一致 | P0 |
| FR-003-05 | **groupId 不得出现在 Java Bean 中** | P0 |
| FR-003-06 | **occurrenceCount 不得出现在 Java Bean 中** | P0 |
| FR-003-07 | 支持处理不规范字段名（特殊字符、非驼峰、描述性文本） | P0 |
| FR-003-08 | **重复字段名检测：发现重复时报错并停止生成** | P0 |
| FR-003-09 | 嵌套对象的命名需严格遵循 XML 中定义的对象名称 | P0 |
| FR-003-10 | **默认使用 Lombok @Data 注解** | P0 |
| FR-003-11 | 支持参数化配置切换为传统 getter/setter 方法 | P1 |

**重复字段名处理策略**:
- 在 camelCase 转换后，检测同一层级是否存在重复字段名
- 如发现重复，报错并输出：
  - 原始字段名
  - 转换后的字段名
  - 所在 Sheet 和行号
  - 冲突的其他字段信息
- **不自动重命名**，强制用户修正 Excel 规范源头问题

**代码生成模式配置**:
- **默认模式**: 使用 Lombok `@Data` 注解（简洁、推荐）
- **传统模式**: 生成显式 getter/setter 方法（通过配置参数 `--use-lombok=false` 切换）
- 两种模式生成的字段定义完全一致，仅方法生成方式不同

#### 3.3.4 Java 数据类型映射规则

| Excel dataType | Java Type | 说明 |
|---------------|-----------|------|
| String / AN | String | 字符串类型 |
| Number / N | String | 定长报文中数字通常保持为字符串 |
| Amount / Currency | BigDecimal | 金额类型 |
| Date | String | 日期通常为格式化字符串 |
| Object (1..1) | 嵌套 Class | 复合对象 |
| Array (0..N, 1..N) | List<T> | 数组对象 |

#### 3.3.5 字段命名转换规则

| 原始名称示例 | 转换后名称 | 规则说明 |
|-------------|-----------|---------|
| DOMICILE_BRANCH | domicileBranch | 下划线转驼峰 |
| response-code | responseCode | 连字符转驼峰 |
| ResponseCode | responseCode | 首字母小写 |
| 特殊字符!@# | 移除特殊字符 | 仅保留字母数字 |
| 123StartWithNumber | _123StartWithNumber | 数字开头加下划线 |

#### 3.3.6 验收标准

- [ ] 类名符合 Request/Response 后缀规范
- [ ] 所有字段名均为 camelCase
- [ ] 数据类型与 XML Bean 一致
- [ ] groupId 和 occurrenceCount 未出现在生成的 Java Bean 中
- [ ] 嵌套对象结构正确
- [ ] 代码可编译通过

---

### 3.4 OpenAPI YAML 生成 (FR-004)

#### 3.4.1 功能描述

自动生成符合 OpenAPI Specification 3.x 的 API YAML 定义文件。

#### 3.4.2 用户故事

**US-004**: 作为开发人员，我希望自动生成 OpenAPI YAML 文件，以便通过 Maven 插件自动生成 Controller 接口代码。

#### 3.4.3 详细需求

| 需求编号 | 需求描述 | 优先级 |
|---------|---------|--------|
| FR-004-01 | 生成符合 OAS 3.x 规范的 YAML 文件 | P0 |
| FR-004-02 | YAML 按目录拆分：headers / request / response / error | P0 |
| FR-004-03 | 使用 $ref 进行文件间引用 | P0 |
| FR-004-04 | **API Endpoint 自动从 Shared Header 的 "Operation Name" 派生** | P0 |
| FR-004-05 | **groupId 不得出现在 YAML 中** | P0 |
| FR-004-06 | **occurrenceCount 不得出现在 YAML 中** | P0 |
| FR-004-07 | 字段定义与 Java Bean / XML Bean 保持一致 | P0 |
| FR-004-08 | 正确设置 required、default、type 属性 | P0 |

**API Endpoint 自动派生规则**:
- **输入源**: Shared Header 中的 "Operation Name" 字段值
- **派生规则**:
  - 将 Operation Name 转换为 kebab-case（小写+连字符）
  - 默认 HTTP Method: POST
  - 默认路径格式: `/api/v1/{operation-name}`
- **示例**:
  - Operation Name: "Create Application"
  - 生成 Endpoint: `POST /api/v1/create-application`
- 如 Shared Header 中无 "Operation Name"，则报错提示用户补充

#### 3.4.4 YAML 目录结构

```
openapi/
├── api.yaml                    # 主入口文件
├── headers/
│   ├── request-headers.yaml    # 请求头定义
│   └── response-headers.yaml   # 响应头定义
├── schemas/
│   ├── request/
│   │   └── PostRequestSchema.yaml
│   ├── response/
│   │   └── PostResponseSchema.yaml
│   └── common/
│       └── CommonTypes.yaml
└── errors/
    └── ErrorResponse.yaml
```

#### 3.4.5 YAML 类型映射规则

| Excel dataType | OpenAPI type | format | 说明 |
|---------------|--------------|--------|------|
| String / AN | string | - | 字符串 |
| Number / N | string | - | 保持字符串以保证定长 |
| Amount / Currency | string | decimal | 金额 |
| Date | string | date | 日期 |
| Object (1..1) | object | - | 嵌套对象 |
| Array (0..N, 1..N) | array | - | 数组 |

#### 3.4.6 验收标准

- [ ] 生成的 YAML 通过 OAS 3.x 规范验证
- [ ] 文件按 headers/request/response/error 正确拆分
- [ ] $ref 引用路径正确且可解析
- [ ] 字段定义与 Java Bean / XML Bean 一致
- [ ] groupId 和 occurrenceCount 未出现在 YAML 中
- [ ] Maven OpenAPI 插件可正确生成代码

---

### 3.5 字段差异输出 (FR-005)

#### 3.5.1 功能描述

生成 diff.md 文件，记录 Excel 原始字段名与生成后字段名的映射关系。

#### 3.5.2 用户故事

**US-005**: 作为开发人员，我希望查看字段名称的转换对照表，以便理解原始规范与生成代码的映射关系。

#### 3.5.3 详细需求

| 需求编号 | 需求描述 | 优先级 |
|---------|---------|--------|
| FR-005-01 | 生成 diff.md 文件 | P0 |
| FR-005-02 | 以表格形式输出映射关系 | P0 |
| FR-005-03 | 包含原始字段名称列 | P0 |
| FR-005-04 | 包含重命名后的字段名称列 | P0 |
| FR-005-05 | 包含适用范围列（request / response / header） | P0 |
| FR-005-06 | 包含来源信息（sheet名、行号） | P1 |

#### 3.5.4 diff.md 格式示例

```markdown
# 字段名称映射表

生成时间: 2026-01-03T10:00:00Z
源文件: create_app.xlsx

## Request 字段

| 原始名称 | 生成名称 | 数据类型 | 来源 Sheet | 行号 |
|---------|---------|---------|-----------|------|
| DOMICILE_BRANCH | domicileBranch | String | Request | 15 |
| RESPONSE_CODE | responseCode | String | Request | 16 |

## Response 字段

| 原始名称 | 生成名称 | 数据类型 | 来源 Sheet | 行号 |
|---------|---------|---------|-----------|------|
| REASON_CODE | reasonCode | String | Response | 22 |

## Shared Header 字段

| 原始名称 | 生成名称 | 数据类型 | 来源 Sheet | 行号 |
|---------|---------|---------|-----------|------|
| CONSUMER_ID | consumerId | String | Header | 5 |
```

#### 3.5.5 验收标准

- [ ] diff.md 文件成功生成
- [ ] 表格格式正确，可在 Markdown 渲染器中正常显示
- [ ] 所有字段映射均被记录
- [ ] 来源信息可追溯

---

### 3.6 报文一致性验证 (FR-006)

#### 3.6.1 功能描述

提供能力对比实际 MQ 测试报文与 Excel Message Spec 定义的一致性。

#### 3.6.2 用户故事

**US-006**: 作为测试人员，我希望验证实际 MQ 报文是否符合 Excel 规范，以便快速定位报文问题。

#### 3.6.3 详细需求

| 需求编号 | 需求描述 | 优先级 |
|---------|---------|--------|
| FR-006-01 | 支持输入实际 MQ 报文内容（定长字符串） | P0 |
| FR-006-02 | 按 Excel 规范逐字段解析报文 | P0 |
| FR-006-03 | 验证字段长度是否符合规范 | P0 |
| FR-006-04 | 验证字段顺序是否符合规范 | P0 |
| FR-006-05 | 验证默认值/填充规则是否符合规范 | P1 |
| FR-006-06 | 生成可定位的错误报告 | P0 |
| FR-006-07 | 报告包含：字段名、期望值、实际值、位置偏移量 | P0 |

#### 3.6.4 验证报告格式示例

```markdown
# 报文验证报告

验证时间: 2026-01-03T10:00:00Z
报文类型: Request
报文长度: 1024 bytes

## 验证结果: FAILED

### 错误列表

| 字段名 | 偏移量 | 期望长度 | 实际长度 | 期望值 | 实际值 | 错误类型 |
|-------|--------|---------|---------|--------|--------|---------|
| domicileBranch | 0-10 | 10 | 10 | - | "BRANCH001" | OK |
| responseCode | 10-13 | 3 | 3 | "00" | "99" | VALUE_MISMATCH |

### 详细说明

1. responseCode: 期望默认值 "00"，实际值为 "99"
```

#### 3.6.5 验收标准

- [ ] 能够正确解析定长报文
- [ ] 能够识别长度不一致的字段
- [ ] 能够识别值不符合预期的字段
- [ ] 错误报告包含精确的位置信息
- [ ] 报告可用于快速定位问题

---

## 4. 非功能需求

### 4.1 性能要求 (NFR-001)

| 指标 | 要求 | 说明 |
|-----|------|------|
| Excel 解析时间 | < 5 秒 | 500 行以内的 Excel 文件 |
| 全量生成时间 | < 30 秒 | 包含 XML、Java、YAML 所有制品 |
| 内存占用 | < 512 MB | 单次运行峰值 |

### 4.2 可靠性要求 (NFR-002)

| 指标 | 要求 | 说明 |
|-----|------|------|
| 确定性 | 100% | 相同输入必须产生相同输出 |
| 错误处理 | 明确提示 | 解析失败时提供具体行号和原因 |
| 回滚能力 | 支持 | 生成失败时不产生部分文件 |

### 4.3 可维护性要求 (NFR-003)

| 指标 | 要求 | 说明 |
|-----|------|------|
| 模板可配置 | 支持 | XML 模板、Java 模板可替换 |
| 规则可扩展 | 支持 | 类型映射规则可扩展 |
| 日志级别 | 可配置 | 支持 DEBUG / INFO / WARN / ERROR |

### 4.4 兼容性要求 (NFR-004)

| 指标 | 要求 | 说明 |
|-----|------|------|
| Java 版本 | 11+ | 兼容 Java 11 及以上版本 |
| Excel 格式 | .xlsx | 支持 Office 2007+ 格式 |
| OpenAPI 版本 | 3.0.x / 3.1.x | 支持 OAS 3.x 规范 |

### 4.5 安全性要求 (NFR-005)

| 指标 | 要求 | 说明 |
|-----|------|------|
| 敏感数据 | 不记录 | 日志中不记录报文内容 |
| 文件访问 | 仅读取 | 仅读取指定的输入文件 |

---

## 5. 配置参数与命令行接口

### 5.1 命令行参数规范

| 参数名称 | 必需 | 说明 | 默认值 | 示例 |
|---------|------|------|--------|------|
| `--input` | 是 | Message Spec Excel 文件路径 | - | `--input=create_app.xlsx` |
| `--shared-header` | 否 | Shared Header Excel 文件路径 | - | `--shared-header=shared_v2.xlsx` |
| `--project` | 是 | 项目名称（用于包名：com.rtm.{project}） | - | `--project=creditcard` |
| `--output` | 否 | 输出根路径 | `./output` | `--output=/path/to/output` |
| `--use-lombok` | 否 | 是否使用 Lombok 注解 | `true` | `--use-lombok=false` |

### 5.2 配置文件格式（可选）

支持通过配置文件（如 `config.yml`）提供参数：

```yaml
input: create_app.xlsx
sharedHeader: shared_v2.xlsx
project: creditcard
output: ./output
useLombok: true
audit:
  outputPath: ./output/audit
  packagePrefix: com.rtm.creditcard.audit
```

### 5.3 使用示例

**命令行方式**:
```bash
# 基本用法
java -jar mq-generator.jar --input=create_app.xlsx --project=creditcard

# 完整参数
java -jar mq-generator.jar \
  --input=create_app.xlsx \
  --shared-header=shared_v2.xlsx \
  --project=creditcard \
  --output=./generated \
  --use-lombok=false
```

**配置文件方式**:
```bash
java -jar mq-generator.jar --config=config.yml
```

---

## 6. 数据模型与映射规则

### 6.1 Excel 规范解析规则

#### 6.1.1 Seg lvl（层级识别）

| Seg lvl 值 | 含义 | 处理规则 |
|-----------|------|---------|
| 1 | 顶层字段 | 直接作为根对象的子元素 |
| 2 | 二级字段 | 作为最近 Seg lvl=1 对象的子元素 |
| N | N 级字段 | 作为最近 Seg lvl=N-1 对象的子元素 |

#### 6.1.2 对象与数组识别

| 条件 | 类型 | 生成规则 |
|-----|------|---------|
| Field Name 形如 `a:A`，Length 为空 | 对象定义 | 创建新的对象节点 |
| occurrenceCount = `0..N` 或 `1..N` | 数组 | Java: `List<T>`，XML: `RepeatingField` |
| occurrenceCount = `1..1` | 复合对象 | Java: 嵌套类，XML: `CompositeField` |

#### 6.1.3 Hard code Value 规则（Request 报文）

| "Hard code Value for MNL" 值 | 处理规则 |
|------------------------------|---------|
| 具体值（如 "CREATEAPP"） | 作为 XML defaultValue |
| 枚举格式（如 "a=1,b=2"） | 取第一个值（1）作为默认值 |
| "BLANK" | 按字段长度填充空字符串 |
| "Refer Column S for Value Listing" | 根据 S 列规则取值 |

#### 6.1.4 Shared Header 特殊规则

| 位置 | 含义 | 使用场景 |
|-----|------|---------|
| "Operation Name" 后单元格 | API 功能语义 | 生成默认 API 名称 |
| "Operation ID" 后单元格 | 操作标识 | 生成 Java Bean 顶层类名 |

### 6.2 类型映射规则汇总

#### 6.2.1 Excel -> 中间 JSON

| Excel 列 | JSON 属性 | 说明 |
|---------|----------|------|
| Field Name | originalName | 原始字段名 |
| - | camelCaseName | 转换后的驼峰名称 |
| Seg lvl | segLevel | 层级数字 |
| Length | length | 字段长度 |
| Message Datatype | dataType | 数据类型 |
| Description (for groupId) | groupId | 组标识默认值 |
| Description (for occurrenceCount) | occurrenceCount | 出现次数 |
| Hard code Value for MNL | hardCodeValue | 硬编码值 |
| Sheet Name | _source.sheetName | 来源 sheet |
| Row Number | _source.rowIndex | 来源行号 |

#### 6.2.2 中间 JSON -> XML Bean

| JSON 属性 | XML 属性 | 说明 |
|----------|---------|------|
| camelCaseName | name | 字段名称 |
| length | length | 字段长度 |
| dataType | converter | 转换器类型 |
| defaultValue | defaultValue | 默认值 |
| isArray | type="RepeatingField" | 数组类型 |
| isObject | type="CompositeField" | 复合对象类型 |
| groupId | (transitory field) | 组标识字段 |
| occurrenceCount | fixedCount | 固定数量 |

#### 6.2.3 中间 JSON -> Java Bean

| JSON 属性 | Java 元素 | 说明 |
|----------|----------|------|
| camelCaseName | 字段名 | 属性名称 |
| dataType | 数据类型 | String/BigDecimal 等 |
| isArray | List<T> | 列表类型 |
| isObject | 嵌套类 | 嵌套对象 |
| **groupId** | **不生成** | **排除** |
| **occurrenceCount** | **不生成** | **排除** |

#### 6.2.4 中间 JSON -> OpenAPI YAML

| JSON 属性 | YAML 属性 | 说明 |
|----------|----------|------|
| camelCaseName | property name | 属性名称 |
| dataType | type | 数据类型 |
| isArray | type: array | 数组类型 |
| isObject | type: object | 对象类型 |
| **groupId** | **不生成** | **排除** |
| **occurrenceCount** | **不生成** | **排除** |

---

## 7. 验证规则

### 7.1 Excel 解析验证

| 验证规则编号 | 验证内容 | 错误级别 |
|------------|---------|---------|
| VR-001 | Excel 文件存在且可读 | ERROR |
| VR-002 | 必需的 Sheet（Request/Response）存在 | ERROR |
| VR-003 | 必需的列（Field Name, Seg lvl 等）存在 | ERROR |
| VR-004 | Seg lvl 值为有效数字 | ERROR |
| VR-005 | 对象定义的 occurrenceCount 格式正确 | ERROR |
| VR-006 | 字段长度为正整数（非对象字段） | WARNING |
| VR-007 | 同一层级内无重复字段名（camelCase 转换后） | ERROR |

### 7.2 跨制品一致性验证

| 验证规则编号 | 验证内容 | 错误级别 |
|------------|---------|---------|
| VR-101 | XML Bean 字段顺序与 Excel 一致 | ERROR |
| VR-102 | Java Bean 字段名与 XML Bean name 属性一致 | ERROR |
| VR-103 | Java Bean 字段类型与 XML Bean converter 匹配 | ERROR |
| VR-104 | YAML schema 属性名与 Java Bean 字段名一致 | ERROR |
| VR-105 | YAML schema 类型与 Java Bean 类型兼容 | ERROR |
| VR-106 | groupId 未出现在 Java Bean 中 | ERROR |
| VR-107 | groupId 未出现在 YAML 中 | ERROR |
| VR-108 | occurrenceCount 未出现在 Java Bean 中 | ERROR |
| VR-109 | occurrenceCount 未出现在 YAML 中 | ERROR |

### 7.3 报文验证规则

| 验证规则编号 | 验证内容 | 错误级别 |
|------------|---------|---------|
| VR-201 | 报文总长度与规范一致 | ERROR |
| VR-202 | 各字段位置偏移正确 | ERROR |
| VR-203 | 字段值长度与规范一致 | ERROR |
| VR-204 | 默认值字段值与规范一致 | WARNING |
| VR-205 | 数组元素数量与声明一致 | ERROR |

---

## 8. 审计要求

### 8.1 审计信息记录

| 审计字段 | 内容 | 存储位置 |
|---------|------|---------|
| 输入 Excel 文件路径 | 绝对路径 | 审计日志 |
| 输入 Excel 文件 Hash | SHA-256 | 审计日志 |
| Shared Header 文件路径 | 绝对路径（如有） | 审计日志 |
| Shared Header 文件 Hash | SHA-256（如有） | 审计日志 |
| 解析器版本 | 语义化版本号 | 审计日志 + 输出元数据 |
| 模板版本 | 语义化版本号 | 审计日志 + 输出元数据 |
| 生成时间 | ISO 8601 格式 | 审计日志 + 输出文件头 |
| 生成规则版本 | 语义化版本号 | 审计日志 |
| 执行用户 | 系统用户名 | 审计日志 |
| 执行环境 | 主机名、OS 版本 | 审计日志 |

**审计日志存储规范**:
- **存储位置**: 遵循包命名前缀规范 `com.rtm.{project}.audit`
- **配置方式**: 支持参数化配置,可通过配置文件或命令行参数指定审计日志输出路径
- **文件命名**: `audit-log-{timestamp}.json` 或 `audit-log.json`(单文件追加模式)
- **默认路径**: `{output}/audit/` 目录下

### 8.2 审计日志格式

```json
{
  "auditId": "uuid",
  "timestamp": "2026-01-03T10:00:00Z",
  "action": "GENERATE",
  "inputs": {
    "specFile": {
      "path": "/path/to/create_app.xlsx",
      "hash": "sha256:abc123..."
    },
    "sharedHeaderFile": {
      "path": "/path/to/shared_header.xlsx",
      "hash": "sha256:def456..."
    }
  },
  "outputs": {
    "jsonTree": "parser/schema/spec-tree.json",
    "xmlBeans": ["outbound-converter.xml", "inbound-converter.xml"],
    "javaBeans": ["CreateApplicationRequest.java", "CreateApplicationResponse.java"],
    "yamlFiles": ["openapi/api.yaml", "..."]
  },
  "versions": {
    "parser": "1.0.0",
    "template": "1.0.0",
    "rules": "1.0.0"
  },
  "executor": {
    "user": "developer",
    "host": "dev-machine",
    "os": "Windows 10"
  },
  "result": "SUCCESS"
}
```

### 8.3 可复现性要求

1. **输入可追溯**: 记录所有输入文件的完整路径和 Hash 值
2. **版本可追溯**: 记录解析器、模板、规则的版本号
3. **确定性输出**: 相同输入 + 相同版本 = 相同输出
4. **回放能力**: 基于审计日志可重新执行生成过程

---

## 9. 验收标准

### 9.1 Excel 解析正确性

| 验收项 | 验收标准 | 验证方法 |
|-------|---------|---------|
| AC-001 | 层级嵌套与 Seg lvl 定义完全一致 | 对比中间 JSON 树与 Excel |
| AC-002 | 数组/对象类型基于 occurrenceCount 正确判断 | 检查 isArray/isObject 标记 |
| AC-003 | 字段顺序与 Excel 行顺序完全一致 | 遍历比对顺序 |
| AC-004 | 所有源元数据均被保留 | 验证 _source 属性完整性 |

### 9.2 中间 JSON 树文件生成

| 验收项 | 验收标准 | 验证方法 |
|-------|---------|---------|
| AC-011 | 输出文件位于 `parser/schema/spec-tree.json` | 文件存在性检查 |
| AC-012 | JSON 符合定义的 Schema | JSON Schema 验证 |
| AC-013 | 相同输入产生相同输出 | 多次运行结果 Hash 比对 |
| AC-014 | 包含完整元数据（sheet、行号、原始名等） | 属性完整性检查 |

### 9.3 XML Bean 生成正确性

| 验收项 | 验收标准 | 验证方法 |
|-------|---------|---------|
| AC-021 | 字段顺序与 Excel 完全一致 | 顺序比对 |
| AC-022 | type 属性值正确（DataField/CompositeField/RepeatingField） | 类型检查 |
| AC-023 | length、defaultValue、converter 等属性正确 | 属性值验证 |
| AC-024 | groupId 作为 transitory field 包含 | XML 结构检查 |
| AC-025 | occurrenceCount 体现为 fixedCount | XML 结构检查 |
| AC-026 | forType 命名符合约定 | 命名规则验证 |
| AC-027 | XML 可被公司组件正确加载 | 组件加载测试 |

### 9.4 Java Bean 生成正确性

| 验收项 | 验收标准 | 验证方法 |
|-------|---------|---------|
| AC-031 | 类名包含 Request/Response 后缀 | 命名检查 |
| AC-032 | 字段名为 camelCase | 命名规则验证 |
| AC-033 | 数据类型与 XML Bean 一致 | 类型比对 |
| AC-034 | **groupId 未出现在 Java Bean 中** | 代码扫描 |
| AC-035 | **occurrenceCount 未出现在 Java Bean 中** | 代码扫描 |
| AC-036 | 嵌套对象结构正确 | 结构验证 |
| AC-037 | 代码可编译通过 | 编译测试 |

### 9.5 OpenAPI YAML 生成正确性

| 验收项 | 验收标准 | 验证方法 |
|-------|---------|---------|
| AC-041 | 符合 OAS 3.x 规范 | OpenAPI Validator 验证 |
| AC-042 | 文件按 headers/request/response/error 正确拆分 | 目录结构检查 |
| AC-043 | $ref 引用路径正确 | 引用解析测试 |
| AC-044 | 字段定义与 Java Bean 一致 | 属性比对 |
| AC-045 | **groupId 未出现在 YAML 中** | YAML 扫描 |
| AC-046 | **occurrenceCount 未出现在 YAML 中** | YAML 扫描 |
| AC-047 | Maven OpenAPI 插件可正确生成代码 | 插件执行测试 |

### 9.6 跨制品一致性检查

| 验收项 | 验收标准 | 验证方法 |
|-------|---------|---------|
| AC-051 | XML/Java/YAML 字段名称一致 | 三方比对 |
| AC-052 | XML/Java/YAML 数据类型兼容 | 类型映射验证 |
| AC-053 | 必填字段定义一致 | 属性比对 |
| AC-054 | 默认值定义一致 | 值比对 |
| AC-055 | 顺序一致性（对顺序敏感的制品） | 顺序比对 |

### 9.7 diff.md 生成

| 验收项 | 验收标准 | 验证方法 |
|-------|---------|---------|
| AC-061 | diff.md 文件成功生成 | 文件存在性检查 |
| AC-062 | 表格包含原始名称、生成名称、范围列 | 格式检查 |
| AC-063 | 所有字段映射均被记录 | 完整性检查 |
| AC-064 | 来源信息可追溯 | 元数据验证 |

### 9.8 审计追溯

| 验收项 | 验收标准 | 验证方法 |
|-------|---------|---------|
| AC-071 | 审计日志包含输入文件 Hash | 日志检查 |
| AC-072 | 审计日志包含版本信息 | 日志检查 |
| AC-073 | 审计日志包含时间戳 | 日志检查 |
| AC-074 | 相同输入可复现相同输出 | 重复执行验证 |

### 9.9 规格与实际报文验证能力

| 验收项 | 验收标准 | 验证方法 |
|-------|---------|---------|
| AC-081 | 能够解析定长报文 | 解析测试 |
| AC-082 | 能够逐字段比对 | 比对测试 |
| AC-083 | 错误报告包含精确位置信息 | 报告格式验证 |
| AC-084 | 错误报告可定位具体问题 | 可用性测试 |

---

## 10. 测试策略

### 13.1 单元测试

| 测试类别 | 测试内容 | 覆盖率要求 |
|---------|---------|-----------|
| Excel 解析器 | Seg lvl 解析、对象识别、类型判断 | >= 90% |
| 命名转换器 | camelCase 转换规则 | >= 95% |
| JSON 树构建器 | 嵌套结构构建、元数据保留 | >= 90% |
| XML 生成器 | 模板填充、属性设置 | >= 85% |
| Java 生成器 | 代码生成、类型映射 | >= 85% |
| YAML 生成器 | Schema 生成、引用处理 | >= 85% |

### 13.2 集成测试

| 测试场景 | 测试内容 | 预期结果 |
|---------|---------|---------|
| IT-001 | 完整 Excel 到全量制品生成 | 所有文件正确生成 |
| IT-002 | Shared Header 合并 | Header 字段正确合并 |
| IT-003 | 复杂嵌套结构 | 多层嵌套正确处理 |
| IT-004 | 数组对象生成 | List 类型正确生成 |
| IT-005 | 跨制品一致性验证 | 验证通过无差异 |

### 11.3 端到端测试

| 测试场景 | 测试内容 | 预期结果 |
|---------|---------|---------|
| E2E-001 | 使用真实 Excel 生成全部制品 | 制品可用于实际项目 |
| E2E-002 | 生成的 XML 被公司组件加载 | 组件正常工作 |
| E2E-003 | 生成的 Java Bean 编译运行 | 编译通过 |
| E2E-004 | 生成的 YAML 被 Maven 插件处理 | Controller 正确生成 |
| E2E-005 | 实际报文验证 | 验证报告正确 |

### 10.4 回归测试

| 测试策略 | 描述 |
|---------|------|
| 基准输出对比 | 保存基准输出，每次变更后对比差异 |
| Hash 验证 | 验证相同输入产生相同输出 Hash |
| 向后兼容 | 新版本能处理旧版本的输入格式 |

### 10.5 边界测试用例

| 测试编号 | 边界条件 | 预期行为 |
|---------|---------|---------|
| BT-001 | 空 Excel 文件 | 提示错误，不生成文件 |
| BT-002 | 单字段 Excel | 正确生成最小结构 |
| BT-003 | 500+ 行 Excel | 性能达标，正确生成 |
| BT-004 | 深度嵌套（10 层） | 正确处理所有层级 |
| BT-005 | 特殊字符字段名 | 正确转换并记录映射 |
| BT-006 | 缺失必需列 | 明确错误提示 |
| BT-007 | 重复字段名 | 报错或自动重命名（待确认） |

---

## 11. 假设与待确认项

### 13.1 假设 (Assumptions)

| 假设编号 | 假设内容 | 影响范围 | 验证方式 |
|---------|---------|---------|---------|
| A-001 | Excel 文件格式为 .xlsx（Office 2007+） | Excel 解析器 | 确认输入文件格式 |
| A-002 | 每个 Excel 文件包含 Request、Response sheet | 解析逻辑 | 确认 Excel 结构 |
| A-003 | Shared Header 为独立 Excel 文件 | 合并逻辑 | 确认 Header 来源 |
| A-004 | 公司内部组件支持当前 XML schema | XML 生成 | 确认组件版本 |
| A-005 | Java Bean 使用标准 getter/setter | Java 生成 | 确认编码规范 |
| A-006 | OpenAPI YAML 使用 3.0.x 版本 | YAML 生成 | 确认 OAS 版本要求 |

### 13.2 待确认项 (To Be Confirmed)

| 待确认编号 | 待确认内容 | 负责人 | 截止日期 | 影响 | 状态 |
|-----------|-----------|--------|---------|------|------|
| ~~TBC-001~~ | ~~Java Bean 是否使用 Lombok 注解~~ | - | - | 代码生成模板 | **✓ 已确认** (默认 Lombok，见 3.3.3) |
| ~~TBC-002~~ | ~~forType 的包名前缀规范~~ | - | - | XML/Java 命名 | **✓ 已确认** (com.rtm.{project}，见 3.2.3) |
| ~~TBC-003~~ | ~~重复字段名的处理策略~~ | - | - | 命名转换器 | **✓ 已确认** (报错并停止，见 3.3.3) |
| ~~TBC-004~~ | ~~API Endpoint 命名规则~~ | - | - | YAML 生成 | **✓ 已确认** (自动派生，见 3.4.3) |
| ~~TBC-005~~ | ~~生成文件的输出目录结构~~ | - | - | 文件输出 | **✓ 已确认** (固定结构，见 11) |
| ~~TBC-006~~ | ~~是否需要支持多个 Message Spec 同时处理~~ | - | - | 批量处理能力 | **✓ 已确认** (仅单文件，见 EX-011) |
| ~~TBC-007~~ | ~~审计日志的存储位置和格式~~ | - | - | 审计模块 | **✓ 已确认** (见 7.1) |
| ~~TBC-008~~ | ~~是否需要 GUI 或 Web 界面~~ | - | - | 交互方式 | **✓ 已确认** (本期排除，见 EX-008) |
| ~~TBC-009~~ | ~~converter 类型完整列表~~ | - | - | XML 生成 | **✓ 已确认** (见 3.2.5) |
| ~~TBC-010~~ | ~~金额类型 floatingNumberLength 计算规则~~ | - | - | 类型映射 | **✓ 已确认** (见 3.2.5) |

### 11.3 输入文件待确认

| 文件 | 状态 | 说明 |
|-----|------|------|
| create_app.xlsx | 已提供 | Message Spec 示例，无法直接读取内容 |
| ISM v2.0 FIX mapping.xlsx | 已提供 | Shared Header 示例，无法直接读取内容 |
| outbound-converter.xml | 已提供 | Request XML Bean 示例，已分析 |
| inbound-converter.xml | 已提供 | Response XML Bean 示例，已分析 |
| sample_code.md | 已提供 | 模板处理代码示例，已分析 |

---

## 12. 输出制品清单

**输出目录结构说明**:
- 本工具采用**固定的标准化目录结构**（如 11.2 所示）
- 所有输出文件按类型分类到对应目录
- 目录结构不可配置，确保跨项目一致性和集成便利性
- 输出根路径可通过参数 `--output=<path>` 指定，默认为 `./output`

### 13.1 主要输出文件

| 输出制品 | 文件路径 | 描述 |
|---------|---------|------|
| 中间 JSON 树 | `parser/schema/spec-tree.json` | Excel 解析后的结构化 JSON |
| Request XML Bean | `{output}/outbound-converter.xml` | 请求报文 XML 定义 |
| Response XML Bean | `{output}/inbound-converter.xml` | 响应报文 XML 定义 |
| Request Java Bean | `{output}/java/{OperationId}Request.java` | 请求 Java 类 |
| Response Java Bean | `{output}/java/{OperationId}Response.java` | 响应 Java 类 |
| 嵌套 Java Bean | `{output}/java/{NestedClassName}.java` | 嵌套对象 Java 类 |
| OpenAPI 主文件 | `{output}/openapi/api.yaml` | API 入口定义 |
| Request Schema | `{output}/openapi/schemas/request/*.yaml` | 请求 Schema 定义 |
| Response Schema | `{output}/openapi/schemas/response/*.yaml` | 响应 Schema 定义 |
| Header Schema | `{output}/openapi/headers/*.yaml` | Header 定义 |
| Error Schema | `{output}/openapi/errors/*.yaml` | 错误定义 |
| 字段映射表 | `{output}/diff.md` | 原始名称与生成名称对照 |
| 审计日志 | `{output}/audit/audit-log.json` | 生成过程审计记录 |
| 验证报告 | `{output}/validation/report.md` | 报文验证结果（按需生成） |

### 13.2 目录结构示例

```
output/
├── parser/
│   └── schema/
│       └── spec-tree.json
├── xml/
│   ├── outbound-converter.xml
│   └── inbound-converter.xml
├── java/
│   ├── CreateApplicationRequest.java
│   ├── CreateApplicationResponse.java
│   ├── ResponseCode.java
│   └── ReasonCode.java
├── openapi/
│   ├── api.yaml
│   ├── headers/
│   │   ├── request-headers.yaml
│   │   └── response-headers.yaml
│   ├── schemas/
│   │   ├── request/
│   │   │   └── PostRequestSchema.yaml
│   │   ├── response/
│   │   │   └── PostResponseSchema.yaml
│   │   └── common/
│   │       └── CommonTypes.yaml
│   └── errors/
│       └── ErrorResponse.yaml
├── diff.md
├── audit/
│   └── audit-log.json
└── validation/
    └── report.md
```

---

## 13. 依赖与风险

### 13.1 外部依赖

| 依赖项                     | 类型 | 描述 | 风险等级 |
|-------------------------|------|------|---------|
| Apache POI              | 库 | Excel 文件解析 | 低 |
| Gson                    | 库 | JSON 处理 | 低 |
| Swagger Parser          | 库 | OpenAPI 验证 | 低 |
| 公司内部 MQ 组件              | 组件 | XML Bean 加载器 | 中 |
| Maven OpenAPI Generator | 插件 | Controller 代码生成 | 低 |

### 13.2 风险矩阵

| 风险编号 | 风险描述 | 可能性 | 影响 | 缓解策略 | 负责人 |
|---------|---------|--------|------|---------|--------|
| R-001 | Excel 格式变更导致解析失败 | 中 | 高 | 支持可配置的列映射 | 待确认 |
| R-002 | 公司内部组件 XML schema 变更 | 低 | 高 | 模板可配置，支持多版本 | 待确认 |
| R-003 | 复杂嵌套结构解析不完整 | 中 | 中 | 充分测试边界用例 | 待确认 |
| R-004 | 字段命名冲突 | 中 | 中 | 定义冲突处理策略 | 待确认 |
| R-005 | 生成代码编译失败 | 低 | 高 | 集成编译测试 | 待确认 |
| R-006 | 性能不达标 | 低 | 中 | 性能测试与优化 | 待确认 |
| R-007 | 跨制品一致性难以保证 | 中 | 高 | 统一从中间 JSON 树生成 | 待确认 |

### 13.3 关键里程碑

| 里程碑 | 描述 | 预计时间 | 交付物 |
|-------|------|---------|--------|
| M1 | 需求评审完成 | 待确认 | 签署的需求文档 |
| M2 | Excel 解析器完成 | 待确认 | 中间 JSON 树生成能力 |
| M3 | XML Bean 生成器完成 | 待确认 | XML Bean 生成能力 |
| M4 | Java Bean 生成器完成 | 待确认 | Java Bean 生成能力 |
| M5 | OpenAPI YAML 生成器完成 | 待确认 | YAML 生成能力 |
| M6 | 一致性验证完成 | 待确认 | 跨制品验证能力 |
| M7 | 报文验证完成 | 待确认 | 规格与报文对比能力 |
| M8 | 集成测试完成 | 待确认 | 测试报告 |
| M9 | 用户验收测试完成 | 待确认 | UAT 签署 |

---

## 文档修订历史

| 版本 | 日期 | 修订人 | 修订内容 |
|-----|------|--------|---------|
| v1.0 | 2026-01-03 | AI Assistant | 初始版本，基于 req-v0.md 和参考文件生成 |
| v1.1 | 2026-01-03 | AI Assistant | 确认 TBC-007 至 TBC-010：<br>- 审计日志存储位置遵循 com.rtm.{project}.audit 规范 (7.1)<br>- Web 界面确认为本期排除 (EX-008)<br>- 补充完整 converter 类型列表 (3.2.5)<br>- 明确 floatingNumberLength 计算规则 (3.2.5) |
| v1.2 | 2026-01-03 | AI Assistant | 确认 TBC-001 至 TBC-006（所有TBC项现已完成）：<br>- TBC-001: 默认使用 Lombok，支持配置切换 (3.3.3)<br>- TBC-002: 包名前缀固定为 com.rtm.{project} (3.2.3)<br>- TBC-003: 重复字段名报错并停止 (3.3.3, 6.1)<br>- TBC-004: API Endpoint 自动从 Operation Name 派生 (3.4.3)<br>- TBC-005: 固定输出目录结构 (11)<br>- TBC-006: 仅支持单文件处理 (EX-011) |

---

## 附录

### 附录 A: 参考文件分析摘要

#### A.1 outbound-converter.xml (Request XML Bean 示例)

**结构特征**:
- 使用 `fix-length-outbound-converter` 作为根元素
- `message` 元素定义顶层请求对象，`forType` 指定 Java 类全限定名
- `field` 元素定义字段，包含 `type`、`length`、`fixedLength`、`transitory`、`defaultValue`、`converter` 等属性
- `CompositeField` 表示复合对象
- `RepeatingField` 表示数组，使用 `fixedCount` 指定元素数量
- groupId 作为 transitory field 存在（`transitory="true"`）

#### A.2 inbound-converter.xml (Response XML Bean 示例)

**结构特征**:
- 使用 `fix-length-inbound-converter` 作为根元素
- 结构与 outbound 类似，用于反序列化响应报文
- 同样支持 `CompositeField` 和 `RepeatingField`

#### A.3 sample_code.md (模板处理代码示例)

**代码模式**:
- Controller 实现 OpenAPI 生成的接口
- PostFlow 使用模板化结构创建 MQ 发送/接收 flow
- RequestMapper 将 OpenAPI Schema 映射到 MQ Java Bean
- ResponseMapper 将 MQ Java Bean 映射回 OpenAPI Schema
- BackendResponseValidator 校验响应结果

**关键洞察**:
- OpenAPI 生成的 Schema 对象与 MQ Java Bean 是不同的对象
- 需要 Mapper 进行字段映射
- 字段名称需要保持一致以简化映射代码

### 附录 B: 术语表

| 术语 | 定义 |
|-----|------|
| Message Spec Excel | 定义 MQ 报文结构的规范文件 |
| Shared Header | 多个 API 共享的报文头部定义 |
| Seg lvl | Segment Level，表示字段在嵌套结构中的层级 |
| groupId | 用于 XML Bean 中标识分组的 transitory 字段 |
| occurrenceCount | 表示对象出现次数，用于判断数组或单一对象 |
| Fixed-Length Message | 定长报文，每个字段占用固定长度 |
| transitory field | XML Bean 中的辅助字段，不映射到 Java Bean |
| CompositeField | XML Bean 中表示复合对象的字段类型 |
| RepeatingField | XML Bean 中表示数组的字段类型 |
| OAS | OpenAPI Specification |

---

*文档结束*
